#!/bin/bash
# Post-receive hook for Fellowsip deployment
# Copy this to /opt/git/fellowsip.git/hooks/post-receive on the production server

set -e

APP_DIR="/opt/apps/fellowsip"
GIT_DIR="/opt/git/fellowsip.git"

echo "=========================================="
echo "Deploying Fellowsip..."
echo "=========================================="

# Pull the latest code
cd $APP_DIR
git --work-tree=$APP_DIR --git-dir=$GIT_DIR checkout -f main

# Self-update the post-receive hook from the repo
# This ensures the deployment script stays in sync with the codebase
if [ -f "$APP_DIR/scripts/post-receive" ]; then
    echo "Updating post-receive hook..."
    cp "$APP_DIR/scripts/post-receive" "$GIT_DIR/hooks/post-receive"
    chmod +x "$GIT_DIR/hooks/post-receive"
fi

# Install dependencies
echo "Installing dependencies..."
npm install

# Run database schema fix (idempotent, non-interactive)
echo "Applying database schema fixes..."
npm run db:fix || echo "Note: db:fix had issues, continuing..."

# Build the application
echo "Building application..."
npm run build

# Restart PM2 processes
echo "Restarting PM2 processes..."
pm2 restart ecosystem.config.js

echo "=========================================="
echo "Deployment complete!"
echo "=========================================="

# Database Migration System

## Overview

This project uses **Drizzle ORM** as the single source of truth for database schema. The schema is defined in `/packages/server/src/db/schema.ts` and migrations are automatically generated and stored in `/packages/server/drizzle/`.

## Important: Migration Workflow

### For Development

1. **Make schema changes** in `/packages/server/src/db/schema.ts`
2. **Generate migration**: `cd packages/server && npx drizzle-kit generate`
3. **Apply migration locally**: `npm run db:migrate`
4. **Commit both** the schema changes AND the generated migration files

### For Production Deployment

The deployment process (via `git push production main`) automatically:
1. Pulls latest code
2. Installs dependencies
3. **Runs `npm run db:migrate`** - applies any new migrations
4. Builds the application
5. Restarts PM2 processes

## One-Time Setup (Already Done)

If you're setting up a new database or migrating from the old manual system:

```bash
# Mark all existing migrations as applied (one-time only)
npm run db:bootstrap
```

This is only needed when:
- Setting up a fresh production database
- Migrating from the old `db:fix` manual script system

## Available Commands

- `npm run db:migrate` - Apply pending migrations (used in deployment)
- `npm run db:bootstrap` - Mark existing migrations as applied (one-time setup)
- `npm run db:fix` - **DEPRECATED** - Old manual migration script (kept for reference)

## Migration Files

Migration files are located in `/packages/server/drizzle/` and follow the naming pattern:
- `0000_third_jack_power.sql`
- `0001_milky_magneto.sql`
- etc.

These files are automatically generated by Drizzle Kit and should **never be manually edited**.

## Troubleshooting

### "relation already exists" error

This means the migration system thinks a table needs to be created, but it already exists. Solutions:

1. **For local development**: Run `npm run db:bootstrap` to sync migration history
2. **For production**: SSH into the server and run `npm run db:bootstrap` once

### Schema changes not applying in production

1. Verify you generated the migration: `cd packages/server && npx drizzle-kit generate`
2. Verify you committed the migration files in `/packages/server/drizzle/`
3. Check deployment logs for migration errors
4. If needed, SSH to production and manually run `npm run db:migrate`

## Why This System?

**Before**: We used a manual `fix-db-columns.ts` script that had to be manually updated every time the schema changed. This led to:
- Schema and migration script getting out of sync
- Manual fixes needed on every deployment
- No migration history tracking

**Now**: Drizzle ORM automatically:
- Generates migration files from schema changes
- Tracks which migrations have been applied
- Ensures production database matches the schema
- Provides rollback capability (if needed)

## Production Database Access

To run migrations manually on production (if needed):

```bash
ssh cobbler@192.168.1.43
cd /opt/apps/fellowsip
npm run db:migrate
```
